{% extends 'chat_main.html' %}

{% load static %}

{% block content %}
    
<div class="container-fluid">
    <div class="row h-100">
        <!-- Left Panel -->
        <div class="col-3 col-md-4 col-lg-3 chat-list-wrapper d-none d-md-block">
            <div class="chat-list">

                <div class="chat-list-header d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <img src="{% static 'img/logo_2.png' %}" alt="Logo" style="max-width: 50px;" class="me-2">
                        <span style="font-size: 20px;">Chatrooms</span>
                    </div>
                    <a href="/" class="btn btn-dark" style="border-radius: 20px;">
                        Back to Posts
                    </a>
                </div>

                <hr>

                <div class="chat-list-header">
                    <i class="fas fa-lock me-2"></i>
                    Private
                </div>                    

                {% for chat in request.user.profile.chats.all %}
                    {% if chat.is_private %}
                        {% for member in chat.members.all %}
                            {% if member != request.user.profile %}

                                <div class="chat-item d-flex justify-content-between align-items-center">
                                    <a href="{% url 'chat:chatroom' chat.name %}" class="chat-link">
                                        <div class="d-flex align-items-center">
                                            <img src="{{ member.image.url }}" alt="Avatar" class="avatar">
                                            {{ member.get_username }}
                                        </div>
                                    </a>
                                    <button class="btn btn-sm chat-more-button">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                </div>

                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}

                <hr>

                <div class="chat-list-header d-flex align-items-center">
                    <i class="fas fa-globe me-2"></i>
                    Public
                </div>

                <div class="chat-item d-flex justify-content-between align-items-center">
                    <a href="{% url 'chat:chatroom' 'public-chat' %}" class="chat-link">
                        <div class="d-flex align-items-center">
                            <img src="{% static 'img/c3.png' %}" alt="Avatar" class="avatar">
                            Public Chat
                        </div>
                    </a>
                    <button class="btn btn-sm chat-more-button">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                </div>

            </div>
        </div>

        <!-- Chat Window -->
        <div class="col-12 col-md-8 col-lg-9 chat-window">
            <!-- Header -->

            <div class="chat-header d-flex justify-content-center align-items-center position-relative p-3">
                <a href="" class="position-absolute start-0 ms-2 mb-2 mt-2 chat-link">
                    <!-- <img class="avatar" src="{% static 'img/c1.jpg' %}" alt="User Avatar"> -->
                    <strong>{{ other_user.get_username }}</strong>
                </a>
                <span>
                    <span id="online-count"><strong></strong></span>

                    <!-- <span class="online-status-indicator"></span> -->
                    <span class="online-status ms-1">online</span>
                </span>
                <div class="dropdown position-absolute end-0 me-2">
                    <button class="btn chat-more-button dropdown-toggle" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                        <li><a class="dropdown-item" href="#">Profile</a></li>
                        <li><a class="dropdown-item" href="#">Settings</a></li>
                        <li><a class="dropdown-item text-danger" href="#">Log out</a></li>
                    </ul>
                </div>
            </div>

            <!-- Messages -->
            <div class="chat-messages" id='chat_messages'>

                {% for message in messages reversed %}
                    {% include 'chat/message.html' %}
                {% endfor %}

            </div>
            

            <!-- Footer -->
            <form class="chat-footer border-top d-flex align-items-center"
                hx-ext="ws"
                ws-connect="/ws/chat/public-chat/"
                ws-send
                _="on htmx:wsAfterSend reset() me"
            >
                {% csrf_token %}

                {{ form.body }}

                <button class="btn" type="submit">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
</div>

{% endblock content %}

{% block javascript %}

<script>
    function scrollToBottom() {
        const container = document.getElementById('chat_messages');
        container.scrollTop = container.scrollHeight;
    }
    scrollToBottom()
</script>
    
{% endblock javascript %}