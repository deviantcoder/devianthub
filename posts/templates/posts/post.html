{% extends 'main.html' %}

{% load static %}

{% block content %}

    <!-- PAGE CONTENT -->
    <section class="section">
        <div class="container">
            <div class="columns is-centered">

                <!-- SIDE PANEL -->
                {% include 'posts/left_side_panel.html' %}

                <!-- POST -->
                <div class="column is-8">
                    <div class="content">
                        <div class="box" style="background: linear-gradient(45deg, #0f182d, #0d2823);">
                            <article class="media">
                                <div class="media-content">
                                    <div class="content">

                                        <!-- POST CONTROLS -->
                                        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
                                            <div class="item" style="display: flex; align-items: center;">
                                                <a href="{{ request.GET.feed }}" class="back-link">
                                                    <span class="icon is-small">
                                                        <i class="fas fa-arrow-left" style="font-size: 12px;"></i>
                                                    </span>
                                                </a>
                                            </div>
                                            
                                            {% include 'posts/post_controls.html' %}
                                            
                                        </div>
                                        
                                        <div class="community-item recent-item">
                                            <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
                                                <div class="item" style="display: flex; align-items: center;">
                                                    <img src="{% static 'img/profile.jpg' %}" alt="Logo" class="community-image-small" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;">
                                                    <div style="display: flex; flex-direction: column; margin-left: 0;">
                                                        <a href="" class="recent-post-link" style="text-align: left; margin-bottom: -4px; padding-bottom: 0;">
                                                            <span class="is-size-7" style="display: block;">c/webdesign</span>
                                                        </a>
                                                        <a href="" style="text-align: left; color: rgb(190, 190, 190);">
                                                            <span class="username-link" style="display: block; margin-top: -2px; font-size: 13px;">
                                                                {{ post.user.get_username }}
                                                            </span>
                                                        </a>
                                                    </div>
                                                    <span class="is-size-7 ml-3"> •
                                                        {% if post.time_since_posted.type != 'now' %}
                                                            {{ post.time_since_posted.num }}
                                                            {{ post.time_since_posted.type }}{{ post.time_since_posted.num|pluralize }} ago
                                                            {% if post.updated_status %}
                                                                <small class="additional-info">
                                                                    {{ post.updated_status }}
                                                                </small>
                                                            {% endif %}
                                                        {% else %}
                                                            {{ post.time_since_posted.type }}
                                                        {% endif %}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <h3>{{ post.title }}</h3>

                                        {% if post.has_media_files != False %}
                                            {% if post.has_media_files == 1 %}

                                                {% if post.postmedia_set.first.file_ext.type == 'image' %}
                                                    <div class="post-header">
                                                        <a href="#" class="js-modal-trigger" data-target="modal-single-{{ forloop.counter }}" data-image="{{ post.postmedia_set.all.first.file.url }}">
                                                            <img src="{{ post.postmedia_set.first.file.url }}" alt="Post" class="post-image">
                                                        </a>
                                                    </div>

                                                    <!-- Modal -->
                                                    <div id="modal-single-{{ forloop.counter }}" class="modal">
                                                        <div class="modal-background"></div>
                                                        <div class="modal-content">
                                                            <img id="modal-image" src="{{ post.postmedia_set.first.file.url }}" alt="Full Size Image">
                                                        </div>
                                                        <button class="modal-close is-large" aria-label="close"></button>
                                                    </div>
                                                {% else %}
                                                    <div class="post-header">
                                                        <video class="glow-effect" controls style="height: 300px; width: auto; border-radius: 20px;">
                                                            <source src="{{ post.postmedia_set.first.file.url }}" type="video/{{ post.postmedia_set.first.file_ext.ext }}">
                                                        </video>
                                                    </div>
                                                {% endif %}

                                            {% else %}
                                                <section class="carousel">
                                                    <div class="carousel-wrapper">

                                                        {% for media in post.postmedia_set.all %}
                                                            <div class="carousel-slide">
                                                                {% if media.file_ext.type == 'image' %}
                                                                    <a href="#" class="js-modal-trigger" data-target="modal-{{forloop.counter}}" data-image="{{media.file.url}}">
                                                                        <img src="{{ media.file.url }}" alt="Post" class="post-image">
                                                                    </a>
                                                                {% else %}
                                                                    <video class="glow-effect" data-target="modal-{{forloop.counter}}" controls style="height: 300px; width: auto; border-radius: 20px;">
                                                                        <source src="{{ media.file.url }}" type="video/{{ media.file_ext.ext }}">
                                                                    </video>
                                                                {% endif %}
                                                            </div>
                                                        {% endfor %}

                                                    </div>
                                                    <button class="carousel-control prev" style="font-size: 25px; border-radius: 20px;">‹</button>
                                                    <button class="carousel-control next" style="font-size: 25px; border-radius: 20px;">›</button>

                                                    <!-- Modal -->
                                                    <div id="modal-{{forloop.counter}}" class="modal">
                                                        <div class="modal-background"></div>
                                                        <div class="modal-content">
                                                            <img id="modal-image" src="" alt="Full Size Image">
                                                        </div>
                                                        <button class="modal-close is-large" aria-label="close"></button>
                                                    </div>

                                                    <!-- Indicators -->
                                                    <div class="carousel-indicators">
                                                        <!-- Dynamically created -->
                                                    </div>
                                                </section>
                                            {% endif %}
                                        {% endif %}

                                        {% if post.video_url %}
                                            <div class="post-header">
                                                {% if 'youtube' in post.video_url %}
                                                    {% with post.video_url|slice:"32:" as video_id %}
                                                        <iframe class="mb-2" width="560" height="315" src="https://www.youtube.com/embed/{{ video_id }}" frameborder="0" allowfullscreen></iframe>
                                                    {% endwith %}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        
                                        <div class="post-content">
                                            <p>
                                                <span class="post-text">
                                                    {{ post.body|linebreaks }}
                                                </span>
                                                <br>
                                                <small class="additional-info">Posted on: {{ post.created }}</small>
                                            </p>
                                        </div>

                                    </div>
                                    <nav class="level is-mobile">
                                        <div class="level-left">

                                            <!-- up/down voting -->
                                            <div class="vote-group">
                                                <a class="vote-button" aria-label="upvote">
                                                    <span class="icon is-small">
                                                        <i class="fas fa-arrow-up" aria-hidden="true"></i>
                                                    </span>
                                                </a>
                                                <span class="vote-count"><strong>123</strong></span>
                                                <a class="vote-button" aria-label="downvote">
                                                    <span class="icon is-small">
                                                        <i class="fas fa-arrow-down" aria-hidden="true"></i>
                                                    </span>
                                                </a>
                                            </div>
                                            <!-- commenting -->
                                            <div class="vote-group">
                                                <span class="vote-button" aria-label="comments" style="">
                                                    <span class="icon is-small">
                                                        <i class="fas fa-comments" aria-hidden="true"></i>
                                                    </span>
                                                </span>
                                                <span class="vote-count"><strong>{{ post.comments.count }}</strong></span>
                                            </div>
                                            <!-- sharing -->
                                            <div class="vote-group">
                                                <a class="vote-button" aria-label="comments">
                                                    <span class="icon is-small">
                                                        <i class="fas fa-share" aria-hidden="true"></i>
                                                    </span>
                                                </a>
                                            </div>
                                        </div>
                                    </nav>
                                </div>
                            </article>
                        </div>

                        <hr>

                        <!-- COMMENTS -->

                        {% load mptt_tags %}

                        <div class="box">
{#                            <h3>Comments</h3>#}

                            <form class="box" method="post" action="{% url 'posts:comment_post' post.id %}">
                                {% csrf_token %}
                                <h6>Add a comment:</h6>
                                {{ form.body }}
                                <button type="submit" class="button mt-2" style="border-radius: 20px;">Comment</button>
                            </form>
                            
                            {% with comments.count as total_comments %}
                                {% if total_comments %}
                                    <hr>
                                    <div class="mb-5">
                                        <span>
                                            <strong style="font-size: 13px; color: #939393;">
                                                {{ total_comments }} comment{{ total_comments|pluralize }}
                                            </strong>
                                        </span>
                                    </div>
                                {% endif %}
                            {% endwith %}

                            {% recursetree comments %}

                            <article class="media">
                                <figure class="media-left">
                                    <img src="{{ node.user.image.url }}" class="profile-image" alt="" />
                                </figure>
                                <div class="media-content">
                                    <div id="{{ node.id }}" class="content">
                                        <p style="font-size: 15px;">
                                            <strong><a href="" class="comment-username">{{ node.user.get_username }}</a></strong>
                                            <span class="is-size-7 ml-1">• 
                                                {% if node.time_since_posted.type != 'now' %}
                                                    {{ node.time_since_posted.num }}
                                                    {{ node.time_since_posted.type }}{{ node.time_since_posted.num|pluralize }} ago
                                                {% else %}
                                                    {{ node.time_since_posted.type }}
                                                {% endif %}
                                            </span>
                                            <br />
                                            {{ node.body|linebreaks }}

                                        <nav class="btn-group-comment mt-1">
                                            <div class="level-left">
                                                <!-- up/down voting -->
                                                <div class="vote-group-comment">
                                                    <a class="vote-button-comment" aria-label="upvote">
                                                        <span class="icon is-small">
                                                            <i class="fas fa-arrow-up" aria-hidden="true"></i>
                                                        </span>
                                                    </a>
                                                    <span class="vote-count">123</span>
                                                    <a class="vote-button-comment" aria-label="downvote">
                                                        <span class="icon is-small">
                                                            <i class="fas fa-arrow-down" aria-hidden="true"></i>
                                                        </span>
                                                    </a>
                                                </div>
                                                <!-- reply -->
                                                {% if node.level < 5 %}
                                                <div class="vote-group-comment">
                                                    <button class="vote-button-comment" style="width: 75px;" onclick="commentReply('{{ node.id }}')" aria-label="comments">
                                                        <span class="icon">
                                                            <i class="fas fa-reply mr-1" aria-hidden="true"></i>
                                                            Reply
                                                        </span>
                                                    </button>
                                                </div>
                                                {% endif %}
                                                <!-- sharing -->
                                                <div class="vote-group-comment">
                                                    <a class="vote-button-comment" style="width: 75px;" aria-label="comments">
                                                        <span class="icon is-small">
                                                            <i class="fas fa-share mr-1" aria-hidden="true"></i>
                                                            Share
                                                        </span>
                                                    </a>
                                                </div>
                                                <div class="vote-group-comment dropdown is-hoverable">
                                                    <div class="dropdown-trigger">
                                                        <button class="vote-button-comment" aria-label="comments">
                                                            <span class="icon is-small">
                                                                <i class="fas fa-ellipsis-h" style="font-size: 12px;"></i>
                                                            </span>
                                                        </button>
                                                    </div>
                                                    <div class="dropdown-menu" id="dropdown-menu4" role="menu">
                                                        <div class="dropdown-content">
                                                            <div class="dropdown-item">
                                                                <a href="" class="post-title">
                                                                    <i class="fas fa-bookmark mr-3" aria-hidden="true"></i>
                                                                    <strong>Save</strong>
                                                                </a>
                                                            </div>

                                                            <div class="dropdown-item">
                                                                <a href="{% url 'posts:delete_comment' node.id %}" class="post-title">
                                                                    <i class="fas fa-trash mr-3" style="color: red;" aria-hidden="true"></i>
                                                                    <strong>Delete</strong>
                                                                </a>
                                                            </div>

                                                            <div class="dropdown-item">
                                                                <a href="" class="post-title">
                                                                    <i class="fas fa-eye-slash mr-3" aria-hidden="true"></i>
                                                                    <strong>Hide</strong>
                                                                </a>
                                                            </div>
                                                            <div class="dropdown-item">
                                                                <a href="" class="post-title">
                                                                    <i class="fas fa-flag mr-3" aria-hidden="true"></i>
                                                                    <strong>Report</strong>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </nav>

                                    </p>
                                </div>
                            </article>
                            <hr>
                                {% if not node.is_leaf_node %}
                                    <div class="children ml-6">
                                        {{ children }}
                                    </div>
                                {% endif %}
                            {% endrecursetree %}

                            <!-- {% if comments.has_other_pages %}
                                <nav class="pagination" role="navigation" aria-label="pagination">
                                    <a class="pagination-link" href="?page=1" aria-label="Previous page">&#10094;&#10094;</a>
                                    {% if comments.has_previous %}
                                        <a class="pagination-link" href="?page={{ comments.previous_page_number }}" aria-label="Previous page">&#10094;</a>
                                    {% else %}
                                        <a class="pagination-link is-disabled" aria-label="Previous page">&#10094;</a>
                                    {% endif %}

                                    {% for page in custom_range %}
                                        {% if page == comments.number %}
                                            <a class="pagination-link number" href="?page={{ page }}" aria-label="Page 1" aria-current="page">{{ page }}</a>
                                        {% else %}
                                            <a class="pagination-link number" href="?page={{ page }}" aria-label="Page 1">{{ page }}</a>
                                        {% endif %}
                                    {% endfor %}

                                    {% if comments.has_next %}
                                        <a class="pagination-link" href="?page={{ comments.next_page_number }}" aria-label="Next page">&#10095;</a>
                                    {% else %}
                                        <a class="pagination-link is-disabled" aria-label="Next page">&#10095;</a>
                                    {% endif %}
                                    <a class="pagination-link" href="?page={{ paginator.num_pages }}" aria-label="Next page">&#10095;&#10095;</a>
                                </nav>
                            {% endif %} -->


                        </div>
                    
                    </div>
                </div>
    
            {% include 'posts/post_right_side_panel.html' %}    
            
            </div>
        </div>
    </section>

    <script>
        function commentReply(id) {
            if (document.contains(document.getElementById("newForm"))) {
                document.getElementById("newForm").remove();
            }

            var comment = document.getElementById(id);
            comment.insertAdjacentHTML('afterend',
                '<form id="newForm" method="post" class="box" action="{% url "posts:comment_post" post.id %}"> \
                        {% csrf_token %} \
                        <select name="parent" class="is-hidden" id="id_parentt"> \
                            <option value="' + id + '" selected="' + id + '"></option> \
                        </select> \
                        <textarea name="body" class="textarea" required id="id_content" style="resize: vertical; height: 50px; min-height: 50px; max-height: 200px; border-radius: 20px;"></textarea> \
                        <a class="button mt-2" style="border-radius: 20px;" onclick="removeForm()">Cancel</a> \
                        <button type="submit" class="button is-info mt-2" style="border-radius: 20px;">Reply</button> \
                </form>');
        }
        document.addEventListener("DOMContentLoaded", function() {
            const textarea = document.querySelector('textarea[name="body"]');

            textarea.addEventListener('input', function() {
                this.style.height = '50px';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });
        })
        function removeForm() {
            const form = document.getElementById("newForm");
            if (form) {
                form.remove();
            }
        }
    </script>

{% endblock content %}